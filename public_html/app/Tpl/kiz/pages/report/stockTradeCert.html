{include file="inc/header.html"}

<div class="article-header">
    <div class="center-block w1200">
        <h1>库存交易凭证（日志）</h1>

        <div class="btn-wrap pull-right tar">
            <a href="#" class="btn-link ml10" onclick="exportResult()">导出</a>
        </div>
    </div>
</div>
<div class="center-block panel-group mt20">
    <!-- 左栏 start -->
    <div class="aside">
        <form id="queryConditions" action="#" method="post" autocomplete="off">
            <!-- 模糊查询 start -->
            <div class="aside-column panel-search">
                <h2>模糊查询</h2>

                <div class="search-box">
                    <input type="text" name="skuNameOrCode" id="skuNameOrCode" class="form-control"
                           placeholder="请输入商品名称/编码" data-format="skuName" maxlength="14">
                    <button type="button" class="close" aria-hidden="true">&times;</button>
                </div>
                <div class="search-box mt10">
                    <input type="text" name="referenceNo" id="referenceNo" class="form-control" placeholder="请输入单据号"
                           data-format="sn" maxlength="14">
                    <button type="button" class="close" aria-hidden="true">&times;</button>
                </div>
            </div>
            <!-- 模糊查询 end -->

            <!-- 商户 start -->
            <div class="aside-column multi-select">
                <h2>商户</h2>
                <div class="select-control"><em></em></div>
                <div class="multi-select-con" style="display:none;">
                    <ul class="multi-select-items">
                        <li>
                            <label class="checkbox" for="commercialId-all">
                                <span></span>
                                <input type="checkbox" id="commercialId-all">全部
                            </label>
                        </li>

                        <li>
                            <label class="checkbox" for="commercialId-1">
                                <span></span>
                                <input type="checkbox" name="commercialIds" id="commercialId-1"
                                       value="-1" data-text="(品牌)">(品牌)
                            </label></li>

                        <li>
                            <label class="checkbox" for="commercialId-2">
                                <span></span>
                                <input type="checkbox" name="commercialIds" id="commercialId-2"
                                       value="810019565" data-text="客如云电商部1号演示门店">客如云电商部1号演示门店
                            </label></li>

                    </ul>
                </div>
                <input type="hidden" value="" />
            </div>
            <!-- 商户 end -->

            <!-- 仓库 start -->
            <div class="aside-column multi-select">
                <h2>仓库</h2>
                <div class="select-control"><em id="wmId-all-em"></em></div>
                <div class="multi-select-con" style="display:none;">
                    <ul class="multi-select-items" id="wmId-all-ul">
                    </ul>
                </div>
                <input type="hidden" value="" />
            </div>
            <!-- 仓库 end -->

            <!-- 单据类型 start -->
            <div class="aside-column multi-select">
                <h2>单据类型</h2>
                <div class="select-control"><em></em></div>
                <div class="multi-select-con" style="display:none;">
                    <ul class="multi-select-items">
                        <li>
                            <label class="checkbox" for="order-type-all">
                                <span></span>
                                <input type="checkbox" id="order-type-all">全部
                            </label>
                        </li>

                        <li>
                            <label class="checkbox" for="order-type-1">
                                <span></span>
                                <input type="checkbox" name="orderTypes" id="order-type-1"
                                       value="PURCHASE" data-text="验收入库单">验收入库单
                            </label></li>

                        <li>
                            <label class="checkbox" for="order-type-2">
                                <span></span>
                                <input type="checkbox" name="orderTypes" id="order-type-2"
                                       value="PURRET" data-text="验收退货单">验收退货单
                            </label></li>

                        <li>
                            <label class="checkbox" for="order-type-3">
                                <span></span>
                                <input type="checkbox" name="orderTypes" id="order-type-3"
                                       value="COMMRET" data-text="退回单">退回单
                            </label></li>

                        <li>
                            <label class="checkbox" for="order-type-4">
                                <span></span>
                                <input type="checkbox" name="orderTypes" id="order-type-4"
                                       value="SCRAP" data-text="报废单">报废单
                            </label></li>

                        <li>
                            <label class="checkbox" for="order-type-5">
                                <span></span>
                                <input type="checkbox" name="orderTypes" id="order-type-5"
                                       value="TRANSFER" data-text="移库单">移库单
                            </label></li>

                        <li>
                            <label class="checkbox" for="order-type-6">
                                <span></span>
                                <input type="checkbox" name="orderTypes" id="order-type-6"
                                       value="SO" data-text="出库单">出库单
                            </label></li>

                        <li>
                            <label class="checkbox" for="order-type-7">
                                <span></span>
                                <input type="checkbox" name="orderTypes" id="order-type-7"
                                       value="SI" data-text="入库单">入库单
                            </label></li>

                        <li>
                            <label class="checkbox" for="order-type-8">
                                <span></span>
                                <input type="checkbox" name="orderTypes" id="order-type-8"
                                       value="PRODUCT" data-text="自产入库单">自产入库单
                            </label></li>

                        <li>
                            <label class="checkbox" for="order-type-9">
                                <span></span>
                                <input type="checkbox" name="orderTypes" id="order-type-9"
                                       value="CC" data-text="盘点单">盘点单
                            </label></li>

                        <li>
                            <label class="checkbox" for="order-type-10">
                                <span></span>
                                <input type="checkbox" name="orderTypes" id="order-type-10"
                                       value="RECEIVE" data-text="收货单">收货单
                            </label></li>

                        <li>
                            <label class="checkbox" for="order-type-11">
                                <span></span>
                                <input type="checkbox" name="orderTypes" id="order-type-11"
                                       value="SALE_RV" data-text="销售收货单">销售收货单
                            </label></li>

                    </ul>
                </div>
                <input type="hidden" value="" />
            </div>
            <!-- 单据类型 end -->

            <!-- 操作类型 start -->
            <div class="aside-column multi-select">
                <h2>操作类型</h2>
                <div class="select-control"><em></em></div>
                <div class="multi-select-con" style="display:none;">
                    <ul class="multi-select-items">
                        <li>
                            <label class="checkbox" for="operation-type-all">
                                <span></span>
                                <input type="checkbox" id="operation-type-all">全部
                            </label>
                        </li>

                        <li>
                            <label class="checkbox" for="operation-type-1">
                                <span></span>
                                <input type="checkbox" name="operationTypes" id="operation-type-1"
                                       value="1" data-text="确认">确认
                            </label></li>

                        <li>
                            <label class="checkbox" for="operation-type-2">
                                <span></span>
                                <input type="checkbox" name="operationTypes" id="operation-type-2"
                                       value="-1" data-text="反确认">反确认
                            </label></li>

                    </ul>
                </div>
                <input type="hidden" value="" />
            </div>
            <!-- 操作类型 end -->

            <!-- 业务类型 start -->
            <div class="aside-column multi-select">
                <h2>业务类型</h2>

                <div class="select-control"><em></em></div>
                <div class="multi-select-con" style="display:none;">
                    <ul class="multi-select-items">
                        <li>
                            <label class="checkbox" for="biz-type-all">
                                <span></span>
                                <input type="checkbox" id="biz-type-all">全部
                            </label>
                        </li>

                        <li>
                            <label class="checkbox" for="biz-type-1">
                                <span></span>
                                <input type="checkbox" name="bizTypes" id="biz-type-1"
                                       value="IN" data-text="入库">入库
                            </label></li>

                        <li>
                            <label class="checkbox" for="biz-type-2">
                                <span></span>
                                <input type="checkbox" name="bizTypes" id="biz-type-2"
                                       value="OUT" data-text="出库">出库
                            </label></li>

                        <li>
                            <label class="checkbox" for="biz-type-3">
                                <span></span>
                                <input type="checkbox" name="bizTypes" id="biz-type-3"
                                       value="TRANSFER" data-text="移库">移库
                            </label></li>

                    </ul>
                </div>
                <input type="hidden" value="" />
            </div>
            <!-- 业务类型 end -->

            <!-- 确认人 start -->
            <div class="aside-column panel-search">
                <h2>操作人</h2>

                <div class="search-box">
                    <input type="text" name="confirmName" id="confirmName" class="form-control" placeholder="请输入操作人" data-type="text" maxlength="14">
                    <button type="button" class="close" aria-hidden="true">&times;</button>
                </div>

            </div>
            <!-- 确认人 end -->

            <!-- 查询日期 start -->
            <div class="aside-column">
                <h2>查询日期</h2>

                <div class="search-box">
                    <input type="text" name="confirmDateStart" id="confirmDateStart" class="form-control datepicker-start" data-for-element="confirmDateEnd"
                           placeholder="请选择开始日期" data-date-startDate="2017-01-07" data-date-endDate="2017-04-07" value="2017-04-07" readonly>
                    <button type="button" class="close" aria-hidden="true">&times;</button>
                </div>
                <div class="search-box mt10">
                    <input type="text" name="confirmDateEnd" id="confirmDateEnd" class="form-control datepicker-end" data-for-element="confirmDateStart"
                           placeholder="请选择结束日期" data-date-endDate="2017-04-07" value="2017-04-07" readonly>
                    <button type="button" class="close" aria-hidden="true">&times;</button>
                </div>
            </div>
            <!-- 查询日期 end -->
        </form>

        <a class="link undo-all" id="undo-all">全部撤销</a>
        <a class="btn-blue btn-search" onclick="load()">查 询</a>
    </div>
    <!-- 左栏 end -->

    <!-- 右栏 start -->
    <div class="panel main">
        <div class="panel-body">
            <!-- grid start -->
            <table id="grid"></table>
            <div id="gridPager"></div>
            <!-- grid end -->
        </div>
    </div>
    <!-- 右栏 end -->


</div>

<script type="text/javascript" src="/scm_kry/js/scm/commercial-wm-associate.js?v=20170406_201331" ></script>
<script type="text/javascript" src="/scm_kry/js/scm/scm-select-cascading.js?v=20170406_201331" ></script>
<script type="text/javascript" src="/scm_kry/js/scm/wm/inventory/invTran.js?v=20170406_201331" ></script>

<script>

    //商户级联仓库，获取仓库的url
    var refreshWmUrl = "/scm_kry/inventoryTransaction/getWmsByCommercialIds";

    var urlRoot = "/scm_kry/inventoryTransaction";
    var queryUrl = urlRoot + "/query";

    var wareHouseJson = '[{"id":9591,"uuid":null,"brandId":12566,"brandName":null,"commercialId":-1,"commercialName":null,"isDelete":0,"creatorId":-1,"creatorName":null,"createTime":"2016-12-02 14:16:27","updaterId":88888981819,"updaterName":null,"updateTime":"2017-03-25 13:15:02","version":2,"wareshouseCode":"WH001","warehouseName":"-1_总仓库(品牌)","memo":"","isDisable":false,"isDefault":true,"deductionName":null,"isShowDelete":0},{"id":13260,"uuid":null,"brandId":12566,"brandName":null,"commercialId":-1,"commercialName":null,"isDelete":0,"creatorId":88888981819,"creatorName":null,"createTime":"2017-02-23 11:49:31","updaterId":88888981819,"updaterName":null,"updateTime":"2017-03-21 16:28:18","version":1,"wareshouseCode":"WH002","warehouseName":"-1_饮品仓(品牌)","memo":"","isDisable":false,"isDefault":false,"deductionName":null,"isShowDelete":0},{"id":13261,"uuid":null,"brandId":12566,"brandName":null,"commercialId":-1,"commercialName":null,"isDelete":0,"creatorId":88888981819,"creatorName":null,"createTime":"2017-02-23 11:49:43","updaterId":88888981819,"updaterName":null,"updateTime":"2017-03-24 10:11:15","version":1,"wareshouseCode":"WH003","warehouseName":"-1_酒水仓(品牌)","memo":"","isDisable":false,"isDefault":false,"deductionName":null,"isShowDelete":0},{"id":13262,"uuid":null,"brandId":12566,"brandName":null,"commercialId":-1,"commercialName":null,"isDelete":0,"creatorId":88888981819,"creatorName":null,"createTime":"2017-02-23 11:50:57","updaterId":88888981819,"updaterName":null,"updateTime":"2017-03-24 10:12:49","version":1,"wareshouseCode":"WH004","warehouseName":"-1_原材料仓(品牌)","memo":"","isDisable":false,"isDefault":false,"deductionName":null,"isShowDelete":0},{"id":14838,"uuid":null,"brandId":12566,"brandName":null,"commercialId":-1,"commercialName":null,"isDelete":0,"creatorId":88888981819,"creatorName":null,"createTime":"2017-03-24 17:19:09","updaterId":88888981819,"updaterName":null,"updateTime":"2017-03-24 17:19:09","version":1,"wareshouseCode":"WH005","warehouseName":"-1_4号库(品牌)","memo":"","isDisable":false,"isDefault":false,"deductionName":null,"isShowDelete":1},{"id":14839,"uuid":null,"brandId":12566,"brandName":null,"commercialId":-1,"commercialName":null,"isDelete":0,"creatorId":88888981819,"creatorName":null,"createTime":"2017-03-24 17:19:37","updaterId":88888981819,"updaterName":null,"updateTime":"2017-03-24 17:19:37","version":1,"wareshouseCode":"WH006","warehouseName":"-1_5号库(品牌)","memo":"","isDisable":false,"isDefault":false,"deductionName":null,"isShowDelete":1},{"id":9604,"uuid":null,"brandId":12566,"brandName":null,"commercialId":810019565,"commercialName":null,"isDelete":0,"creatorId":-1,"creatorName":null,"createTime":"2016-12-02 15:11:38","updaterId":-1,"updaterName":null,"updateTime":"2016-12-29 19:15:24","version":1,"wareshouseCode":"WH001","warehouseName":"810019565_总仓库(客如云电商部1号演示门店)","memo":"","isDisable":false,"isDefault":true,"deductionName":null,"isShowDelete":0}]';

    var cachedQueryConditions = ''; //缓存页面条件

    var _gridTable = '#grid';

    $(function () {

        initDates();


        var $gridObj = $("#grid");
        $gridObj.dataGrid({
            formId: "queryConditions",
            url: queryUrl,
            rownumbers: false,
            shrinkToFit:false,
            autoScroll: true,
            colNames: [ '商户', '单据号', '单据类型', '操作类型', '业务类型', '出库仓库', '入库仓库', '商品编码',
                '商品名称（规格）', '单位', '价格', '数量', '合计金额', '制单人', '制单时间', '操作人',
                '操作时间', '日志创建时间'],
            colModel: [
                {name: 'commercialName', index: 'commercialName', width: 160},
                {name: 'referenceNo', index: 'referenceNo', align: "center", width: 160},
                {name: 'orderType', index: 'orderType', width: 100},
                {name: 'operationTypeStr', index: 'operationType', width: 100},
                {name: 'bizType', index: 'bizType', width: 100},
                {name: 'fromWmName', index: 'fromWmName', width: 160},
                {name: 'toWmName', index: 'toWmName', width: 160},
                {name: 'skuCode', index: 'skuCode', width: 100},
                {name: 'skuName', index: 'skuName', width: 160},
                {name: 'uom', index: 'uom', width: 100,align: "center"},
                {
                    name: 'price',
                    index: 'price',
                    width: 100,
                    align: "right",
                    formatter: customCurrencyFormatter,
                    hidden: true
                },
                {name: 'qty', index: 'qty', align: "right", width: 100},
                {
                    name: 'totalPrice',
                    index: 'totalPrice',
                    width: 120,
                    align: "right",
                    formatter: customCurrencyFormatter,
                    hidden: true
                },
                {name: 'orderCreatorName', index: 'orderCreatorName', width: 100},
                {name: 'orderCreateTime', index: 'orderCreateTime', align: "center", width: 160},
                {name: 'creatorName', index: 'creatorName', width: 100},
                {name: 'orderConfirmTime', index: 'orderConfirmTime', align: "center", width: 160},
                {name: 'createTime', index: 'createTime', align: "center", width: 160}
            ],
            sortname: 'createTime',
            pager: "#gridPager"
        });


        cachedQueryConditions = serializeFormById('queryConditions');
    });


    function initDates(){
//        var currentDate = new Date().Format('yyyy-MM-dd');
//        $('#confirmDateStart').val(currentDate);
//        $('#confirmDateEnd').val(currentDate);
    }

    function exportResult(){

        var currentQueryConditions = serializeFormById('queryConditions');

        if(currentQueryConditions != cachedQueryConditions){
            $.layerMsg('条件已改变，请先点击查询按钮！', false);
            return false;
        }

        var $gridObj = $("#grid");


        var totalSize = $gridObj.jqGrid('getGridParam','records');

        if(totalSize > 0){

            var sidx = $gridObj.jqGrid('getGridParam','sortname');
            var sord = $gridObj.jqGrid('getGridParam','sortorder');

            //rows=0将获取所有记录，不分页
            var exportUrl = "/scm_kry/inventoryTransaction/export?rows=0&sidx=" + sidx + "&sord=" + sord;

            $("#queryConditions").attr("action", exportUrl).attr("target", "_blank");
            $("#queryConditions").submit();
        } else{
            $.layerMsg('导出记录为空！', false);
        }
    }


    function load() {

        cachedQueryConditions = serializeFormById('queryConditions');
        $(_gridTable).refresh(-1);
    }

    $.setSearchFocus();

</script>

{include file="inc/footer.html"}

</body>
</html>